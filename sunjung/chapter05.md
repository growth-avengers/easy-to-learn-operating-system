# CH05 프로세스 동기화 

# 01 프로세스 간 통신 

## 프로세스 간 통신의 개념 
스레드: 하나의 프로세스 내에서 자원을 공유하는 실행 단위 
<br>
프로세스 간 통신: 운영체제는 프로세스와 프로세스끼리 쉽게 데이터를 주고받을 수 있게 통신 방법을 제공
> - 공유 메모리나 공유 파일을 이용한 통신
>   - 일정한 메모리 영역이나 파일 공유, 이를 통해 데이터 주고받음 
> - 파이프를 이용한 통신
>   - fork(), 부모-자식 간 통신
> - 소켓을 이용한 통신
>   - 네트워크로 연결된 경우 
>   - 초기화할 내용, 시스템 자원 많이 사용 -> 같은 컴퓨터에서는 잘 사용하지 않음 

<br>

## 프로세스 간 통신의 분류 
양방향 통신: 동시에 양쪽 방향으로 전송 가능 
- 소켓

반양방향 통신: 동시 전송 불가능, 특정 시점에 한쪽 방향으로만 전송
- 무전기

단방향 통신: 한쪽 방향으로 데이터 전송
> - 공유파일, 파이프 
> - 양방향 통신을 이용하고 싶으면 메모리 2개 사용해야 함 

공유 메모리의 문제점: 상대방이 데이터를 언제 보낼지 모름 
> - 바쁜대기: 데이터를 받는 쪽에서 반복적으로 공유 메모리 확인해야 함 
> ->해결하기 위해서 
> - 동기화: 메시지가 도착했다고 알려줌 

대기 유무에 따라 
> - 동기화 통신: 대기가 있는 통신 
>   - 파이프, 소켓
> - 비동기화 통신: 대기가 없는 통신, 바쁜 대기 
>   - 공유 메모리, 공유 파일 

<br>
<br>

## 프로세스 간 통신의 종류 
파일을 이용한 통신 
- 운영체제가 프로세스 동기화를 제공하지 않음 
    - 부모 프로세스가 wait() 함수를 이용하여 자식 프로세스의 작업이 끝날 때까지 기다렸다가 작업을 시작함 
> 파일 열기 
> - open()
>   - return fd(파일 기술자): 파일 접근 가능 권한 
>       - 파일을 연 다음에는 파일기술자를 통해서만 파일 접근 가능 

> 파일 쓰기 또는 읽기 
> - write(fd, "Test", 5), 데이터가 저장
> - read(fd, buf, 5), 데이터 가져옴 

> 파일 닫기 
> - close(fd)
<br>
<br>

파이프를 이용한 통신 
- 운영체제가 제공하는 동기화 통신 방식
- 공유 메모리, 공유 파일 -> 단방향 통신
- 양방향 통신을 하기 위해서는 파이프 2개 사용 
> - 이름 없는 파이프: 부모와 자식 프로세스, 같은 부모를 가진 자식 프로세스, 서로 관련 있는 프로세스 
> - 이름 있는 파이프: FIFO 특수 파일 사용, 서로 관련 없는 프로세스 

소켓을 이용한 통신 
> 네트워킹: 여러 컴퓨터에 있는 프로세스끼리 통신 
> - IP주소 
> - 포트번호: 프로세스 구분 번호 
>   - TCP가 네트워크를 사용하는 프로세스를 구분하기 위해 사용하는 주소 
> - 데몬: 서버에서 돌아가는 프로세스 
> - 소켓: 하나의 포트에 여러 클라이언트를 연결 
>   - 클라이언트들은 포트에 연결된 멀티 소켓에 하나씩 연결됨 
>   - 서버 프로세스는 소켓을 사용하여 동시에 여러 클라이언트에 서비스를 제공 
>   - 네트워크에서 데이터를 보낸다는 것은 클라이언트 소켓이 서버 소켓에 데이터를 보내는 것 -> 네트워크 프로그래밍 = 소켓 프로그래밍 

> 네트워킹 
> - 프로시저 호출
>   - 프로시저 호출: 한 컴퓨터 함수 호출 
>   - 원격 프로시저 호출: 다른 컴퓨터 함수 호출
>       - 소켓이용 
>           - 프로세스 동기화 지원, 데이터를 받는 쪽의 프로세스가 바쁜 대기를 하지 않아도 됨 

----

# 02 공유 자원과 임계구역 
프로세스가 한정된 자원을 갖고 공동으로 작업할 때 발생할 수 있는 문제점들 

## 공유 자원에 대한 접근 
공유 자원: 여러 프로세스가 공동으로 이용하는 변수, 메모리, 파일 등
> - 접근 순서 정해야 함
> - 발생 가능한 상황 
>   - 경쟁 조건: 2개 이상의 프로세스가 공유 자원을 병행해서 읽거나 쓰는 상황 
>       - 접근 순서에 따라 실행 결과가 달라질 수 있음 

임계구역: 공유 자원 접근 순서에 따라 실행 결과가 달라지는 프로그램의 영역 
> - 한 프로세스가 임계구역에 들어가면 다른 프로세스는 임계구역 밖에서 기다리고 임계구역에 들어간 프로세스가 나와야 밖에 있던 프로세스가 들어갈 수 있음. 

## 생산자 소비자 문제 
생산자 프로세스와 소비자 프로세스가 서로 독립적으로 작업함 
> - 생산자 input(buf), 소비자 output(buf) -> 원형 버퍼 사용함 
> - 동시에 실행되면 문제가 발생함, 전역변수에 대한 타이밍을 맞추지 않았기 때문에 
> - 하드웨어 자원을 사용할 때도 적용되는 개념

## 임계구역 문제를 해결하기 위한 조건 
> 1. 상호 배제 
>   - 임계구역 내에는 한번에 하나의 프로세스만 
> 2. 한정 대기 
>   - 무한 대기 x
> 3. 진행의 융통성
>   - 다른 프로세스의 진행을 막지 않음 

-----
# 03 임계구역 문제 해결 방법 
<span style="color:red">잠금</span>

## 임계 구역 문제 해결 조건을 고려한 코드 설계
상호 배제 문제 
> - 임계 구역 잠금 확인 
> - 무한 루프를 돌면서 잠금이 해제될 때까지 기다림 
> - 임계구역에 진입할 경우 잠금 걸고, 작업 마치면 잠금 해결 
> <br>

> 발생할 수 있는 문제 
> - 임계구역에 동시 진입 
>   - 바쁜 대기, 자원 낭비 
> - 한정 대기 문제 
>   - 두 프로세스가 모두 임계구역에 진입하지 못하는 무한 대기 현상 발생 
>   - 둘다 while문을 빠져나오지 못해서 무한 루프에 빠져서 임계구역에 진입하지 못함 
>   - <span style="color: red">교착상태</span>: 프로세스가 살아 있으나 작업이 진행되지 못하는 상태 
> - 확장성 문제
>   - 프로세스 증가에 따라 lock 개수 증가 
> - 진행의 융통성 문제 
>   - 경직된 동기화: 프로세스의 진행이 다른 프로세스로 인해 방해받는 현상 

하드웨어로의 해결 방법 
> - 검사와 지정
>   - 명령어 실행 중간에 타임아웃이 걸려 임계구역을 보호하지 못하는 문제가 발생하지 않음 
>   - 바쁜 대기 사용 -> 자원 낭비 

## 피터슨 알고리즘 
> - 공유 변수 turn 
>   - 두 프로세스가 lock을 설정하여 임계구역에 못 들어가는 상황에 대비하기 위함 
>   - 프로세스가 동시에 lock을 설정했어도 turn을 사용하여 다른 프로세스에 양보 
>   - 두개의 프로세스만 사용 가능 
> ```
>   while(lock2 == true && turn == 2)
> ```
>
## 데커 알고리즘 
> - 공유 변수 turn 
> - 누가 먼저 임계 구역에 진입했는지 확인하는 것 

## 세마포어 
> - 스위치를 사용중으로 놓고 임계구역으로 들어감 
>   - 다음 프로세스는 앞의 프로세스가 작업이 끝날 때까지 기다림 
>   - 작업 마치면 다음 프로세스에 임계구역을 사용하라는 동기화 신호를 보냄 
> - 초기 설정
>   - Semaphore(n), n은 공유 가능한 자원의 수 
>       - RS(전역 변수): n으로 초기화, 현재 사용 가능한 자원의 수 저장 
>   - P(): 임계구역 사용중 
>       - 잠금 수행
>   - V(): 임계구역을 나올 때 비었다는 표시 
>       - 잠금 해제, 동기화 수행 
> - wake_up()신호를 받으면 임계구역에 진입 
>   - 바쁜 대기를 하는 프로세스가 없음 
> - 공유 자원이 여러 개일 때도 사용 가능 

## 모니터 
> - 공유 자원을 내부적으로 숨기고 공유 자원에 접근하기 위한 인터페이스만 제공, 자원을 보호, 프로세스 간에 동기화 
> - 시스템 호출: 시스템 자원을 사용자로부터 숨기고 사용자 요구 사항을 처리하는 인터페이스만 제공 


----
# 04 파일, 파이프, 소켓 프로그래밍 
## 파일 
순차파일
> - 파일 내의 데이터는 한줄로 길게 저장 
> - 순차적 접근 
> - 파일 기술자: 어느 위치를 읽고 있는지 

파일을 이용한 통신 
> - open() 후 파일 실행 , 쓰기 연산 후 닫고 종료 
> - 부모 프로세스가 자식 프로세스보다 먼저 실행되면 자식 프로세스가 아무 작업도 하지 않기 때문에 빈 내용을 읽음 
>   - 부모 프로세스와 자식 프로세스 간에 동기화 필요 

## 파이프 
이름 있는 파이프 
이름 없는 파이프 
> 파이프: 부모와 자식 프로세스 혹은 같은 부모의 자식 프로세스처럼 서로 관련 있는 프로세스 간 통신 
> - 단방향 통신이므로 프로세스당 하나의 기술자만 사용 
> - 필요 없는 기술자는 닫아버림 

## 네트워킹 
소켓
> - 양방향 통신, 동기화 함께 진행 
> - 서버: bind()사용하여 생성한 소켓을 특정 포트에 등록함 
>   - 특정 포트에 새로운 소켓을 등록하겠다는 의미 
>   - bind() -> listen() -> accpet() 클라이언트의 connect() -> 작업 시작 

Thinking<br>
*1. 임계구역을 해결하기 위한 조건이 무엇이 있나*<br>
*2. 세마포어 알고리즘의 문제점은 무엇*





